<!DOCTYPE html>
<html>
<head>
    <title>Profile - <%= profileUser.username %></title>
</head>
<body>
    <!-- Navigation Bar -->
    <div style="background-color: #f8f9fa; padding: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="/" style="text-decoration: none; color: #007bff;">‚Üê Back to Home</a>
                <h1 style="margin: 10px 0 0 0;">Profile: <%= profileUser.username %></h1>
            </div>
            <div>
                <span>Logged in as: <%= currentUser %></span>
                <a href="/logout" style="margin-left: 15px; padding: 8px 15px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 4px;">Logout</a>
            </div>
        </div>
    </div>

    <!-- Profile Info -->
    <div style="margin-bottom: 30px;">
        <h2><%= profileUser.username %>'s Posts (<%= posts.length %>)</h2>
        <% if (isOwnProfile) { %>
            <p><em>This is your profile</em></p>
        <% } %>
    </div>

    <!-- Posts List -->
    <div id="postsList">
        <% if (posts.length === 0) { %>
            <p>No posts yet.</p>
        <% } else { %>
            <% posts.forEach(post => { %>
                <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex-grow: 1;">
                            <h3 id="title-<%= post.uid %>"><%= post.title %></h3>
                            <p id="description-<%= post.uid %>"><%= post.description %></p>
                            <small>Posted: <%= new Date(post.timestamp).toLocaleString() %><%= post.edited_timestamp ? ` | Edited: ${new Date(post.edited_timestamp).toLocaleString()}` : '' %></small>
                        </div>
                        
                        <% if (post.canEdit) { %>
                            <div style="margin-left: 10px;">
                                <button onclick="editPost(`<%= post.uid %>`)" style="margin-right: 5px;">Edit</button>
                                <button onclick="deletePost(`<%= post.uid %>`)" style="background-color: #dc3545; color: white;">Delete</button>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- Hidden Edit Form -->
                    <div id="editForm-<%= post.uid %>" style="display: none; margin-top: 10px;">
                        <input type="text" id="editTitle-<%= post.uid %>" value="<%= post.title %>" style="width: 100%; margin-bottom: 5px;">
                        <textarea id="editDescription-<%= post.uid %>" style="width: 100%; margin-bottom: 5px;"><%= post.description %></textarea>
                        <button onclick="saveEdit(`<%= post.uid %>`)">Save</button>
                        <button onclick="cancelEdit(`<%= post.uid %>`)">Cancel</button>
                    </div>
                    
                    <!-- Comments Section -->
                    <div id="comments-<%= post.uid %>" style="margin-top: 15px; padding-left: 20px;">
                        <h4>Comments:</h4>
                        <div id="commentsList-<%= post.uid %>"></div>
                        
                        <!-- Add Comment Form -->
                        <form id="commentForm-<%= post.uid %>" style="margin-top: 10px;">
                            <input type="text" id="commentContent-<%= post.uid %>" placeholder="Add a comment..." required style="width: 70%;">
                            <button type="submit">Add Comment</button>
                        </form>
                    </div>
                </div>
            <% }) %>
        <% } %>
    </div>

    <script>
        // Load comments for a specific post
        async function loadComments(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                const comments = await response.json();
                
                const commentsList = document.getElementById(`commentsList-${postId}`);
                commentsList.innerHTML = comments.map(comment => `
                    <div style="border-left: 2px solid #ddd; padding-left: 10px; margin: 5px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex-grow: 1;">
                                <p id="commentContent-${comment.uid}">${comment.content}</p>
                                <small>By: <a href="/user/${comment.username}" style="text-decoration: none; color: #007bff;">${comment.username}</a> | Posted: ${new Date(comment.timestamp).toLocaleString()}${comment.edited_timestamp ? ` | Edited: ${new Date(comment.edited_timestamp).toLocaleString()}` : ''}</small>
                            </div>
                            
                            <div style="margin-left: 10px;">
                                ${comment.canEdit ? `<button onclick="editComment(${comment.uid})" style="margin-right: 5px; font-size: 12px;">Edit</button>` : ''}
                                ${comment.canDelete ? `<button onclick="deleteComment(${comment.uid}, ${postId})" style="background-color: #dc3545; color: white; font-size: 12px;">Delete</button>` : ''}
                            </div>
                        </div>
                        
                        <!-- Hidden Edit Form -->
                        <div id="editCommentForm-${comment.uid}" style="display: none; margin-top: 5px;">
                            <input type="text" id="editCommentContent-${comment.uid}" value="${comment.content}" style="width: 80%;">
                            <button onclick="saveCommentEdit(${comment.uid}, ${postId})" style="font-size: 12px;">Save</button>
                            <button onclick="cancelCommentEdit(${comment.uid})" style="font-size: 12px;">Cancel</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }

        // Set up comment form for a specific post
        function setupCommentForm(postId) {
            document.getElementById(`commentForm-${postId}`).addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const content = document.getElementById(`commentContent-${postId}`).value;
                
                try {
                    const response = await fetch(`/api/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    });
                    
                    const result = await response.json();
                    console.log('Comment created:', result);
                    
                    // Clear form and reload comments
                    document.getElementById(`commentContent-${postId}`).value = '';
                    await loadComments(postId);
                    
                } catch (error) {
                    console.error('Error creating comment:', error);
                }
            });
        }

        // Comment edit functions
        function editComment(commentId) {
            document.getElementById(`editCommentForm-${commentId}`).style.display = 'block';
        }

        function cancelCommentEdit(commentId) {
            document.getElementById(`editCommentForm-${commentId}`).style.display = 'none';
        }

        async function saveCommentEdit(commentId, postId) {
            const content = document.getElementById(`editCommentContent-${commentId}`).value;
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadComments(postId);
                } else {
                    alert('Failed to update comment');
                }
                
            } catch (error) {
                console.error('Error updating comment:', error);
                alert('Error updating comment');
            }
        }

        async function deleteComment(commentId, postId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadComments(postId);
                } else {
                    alert('Failed to delete comment');
                }
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment');
            }
        }

        // Post edit functions
        function editPost(postId) {
            document.getElementById(`editForm-${postId}`).style.display = 'block';
        }

        function cancelEdit(postId) {
            document.getElementById(`editForm-${postId}`).style.display = 'none';
        }

        async function saveEdit(postId) {
            const title = document.getElementById(`editTitle-${postId}`).value;
            const description = document.getElementById(`editDescription-${postId}`).value;
            
            try {
                const response = await fetch(`/api/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Refresh the page to show updated content
                    location.reload();
                } else {
                    alert('Failed to update post');
                }
                
            } catch (error) {
                console.error('Error updating post:', error);
                alert('Error updating post');
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This will also delete all comments.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/posts/${postId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    // Redirect to home page after deletion
                    window.location.href = '/';
                } else {
                    alert('Failed to delete post');
                }
                
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Error deleting post');
            }
        }

        // Load comments for each post when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            `<% posts.forEach(post => { %>`
                await loadComments(`<%= post.uid %>`);
                setupCommentForm(`<%= post.uid %>`);
            `<% }) %>`
        });
    </script>
</body>
</html>
