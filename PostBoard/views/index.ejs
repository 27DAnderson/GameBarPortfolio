<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Board</title>
</head>
<body>
<div>
    <!-- Navigation Bar -->
    <div style="background-color: #f8f9fa; padding: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0;">Post Board</h1>
            <div>
                <span>Welcome, <%= user %>!</span>
                <a href="/logout" style="margin-left: 15px; padding: 8px 15px; background-color: #dc3545; color: white; text-decoration: none; border-radius: 4px;">Logout</a>
            </div>
        </div>
    </div>

    <!-- Create Post Button -->
    <button id="showCreateForm">Create New Post</button>
    
    <!-- Hidden Create Post Form -->
    <div id="createPostForm" style="display: none;">
        <h2>Create New Post</h2>
        <form id="postForm">
            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div>
                <label for="description">Description:</label>
                <textarea id="description" name="description" required></textarea>
            </div>
            <button type="submit">Create Post</button>
            <button type="button" id="cancelCreate">Cancel</button>
        </form>
    </div>
    
    <!-- Posts Display -->
    <div id="postsContainer">
        <h2>All Posts</h2>
        <div id="postsList"></div>
    </div>
</div>


<script>
// Show/hide create form
document.getElementById('showCreateForm').addEventListener('click', () => {
    document.getElementById('createPostForm').style.display = 'block';
});

document.getElementById('cancelCreate').addEventListener('click', () => {
    document.getElementById('createPostForm').style.display = 'none';
    document.getElementById('postForm').reset();
});

// Load posts when page loads
// Load posts when page loads
async function loadPosts() {
    try {
        const response = await fetch('/api/posts');
        const posts = await response.json();
        
        const postsList = document.getElementById('postsList');
        postsList.innerHTML = posts.map(post => `
            <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex-grow: 1;">
                        <h3 id="title-${post.uid}">${post.title}</h3>
                        <p id="description-${post.uid}">${post.description}</p>
                        <small>By: <a href="/user/${post.username}" style="text-decoration: none; color: #007bff;">${post.username}</a> | Posted: ${new Date(post.timestamp).toLocaleString()}${post.edited_timestamp ? ` | Edited: ${new Date(post.edited_timestamp).toLocaleString()}` : ''}</small>

                    </div>
                    
                    ${post.canEdit ? `
                        <div style="margin-left: 10px;">
                            <button onclick="editPost(${post.uid})" style="margin-right: 5px;">Edit</button>
                            <button onclick="deletePost(${post.uid})" style="background-color: #dc3545; color: white;">Delete</button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Hidden Edit Form -->
                <div id="editForm-${post.uid}" style="display: none; margin-top: 10px;">
                    <input type="text" id="editTitle-${post.uid}" value="${post.title}" style="width: 100%; margin-bottom: 5px;">
                    <textarea id="editDescription-${post.uid}" style="width: 100%; margin-bottom: 5px;">${post.description}</textarea>
                    <button onclick="saveEdit(${post.uid})">Save</button>
                    <button onclick="cancelEdit(${post.uid})">Cancel</button>
                </div>
                
                <!-- Comments Section -->
                <div id="comments-${post.uid}" style="margin-top: 15px; padding-left: 20px;">
                    <h4>Comments:</h4>
                    <div id="commentsList-${post.uid}"></div>
                    
                    <!-- Add Comment Form -->
                    <form id="commentForm-${post.uid}" style="margin-top: 10px;">
                        <input type="text" id="commentContent-${post.uid}" placeholder="Add a comment..." required style="width: 70%;">
                        <button type="submit">Add Comment</button>
                    </form>
                </div>
            </div>
        `).join('');
        
        // Load comments for each post and set up comment forms
        for (const post of posts) {
            await loadComments(post.uid);
            setupCommentForm(post.uid);
        }
        
    } catch (error) {
        console.error('Error loading posts:', error);
    }
}

// Edit post functions
function editPost(postId) {
    document.getElementById(`editForm-${postId}`).style.display = 'block';
}

function cancelEdit(postId) {
    document.getElementById(`editForm-${postId}`).style.display = 'none';
}

async function saveEdit(postId) {
    const title = document.getElementById(`editTitle-${postId}`).value;
    const description = document.getElementById(`editDescription-${postId}`).value;
    
    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, description })
        });
        
        const result = await response.json();
        if (result.success) {
            // Refresh posts to show the (edited) label
            loadPosts();
        } else {
            alert('Failed to update post');
        }
        
    } catch (error) {
        console.error('Error updating post:', error);
        alert('Error updating post');
    }
}


async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This will also delete all comments.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            loadPosts(); // Refresh the posts list
        } else {
            alert('Failed to delete post');
        }
        
    } catch (error) {
        console.error('Error deleting post:', error);
        alert('Error deleting post');
    }
}


// Load comments for a specific post
async function loadComments(postId) {
    try {
        const response = await fetch(`/api/posts/${postId}/comments`);
        const comments = await response.json();
        
        const commentsList = document.getElementById(`commentsList-${postId}`);
        commentsList.innerHTML = comments.map(comment => `
            <div style="border-left: 2px solid #ddd; padding-left: 10px; margin: 5px 0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex-grow: 1;">
                        <p id="commentContent-${comment.uid}">${comment.content}</p>
                        <small>By: <a href="/user/${comment.username}" style="text-decoration: none; color: #007bff;">${comment.username}</a> | Posted: ${new Date(comment.timestamp).toLocaleString()}${comment.edited_timestamp ? ` | Edited: ${new Date(comment.edited_timestamp).toLocaleString()}` : ''}</small>
                    </div>
                    
                    <div style="margin-left: 10px;">
                        ${comment.canEdit ? `<button onclick="editComment(${comment.uid})" style="margin-right: 5px; font-size: 12px;">Edit</button>` : ''}
                        ${comment.canDelete ? `<button onclick="deleteComment(${comment.uid}, ${postId})" style="background-color: #dc3545; color: white; font-size: 12px;">Delete</button>` : ''}
                    </div>
                </div>
                
                <!-- Hidden Edit Form -->
                <div id="editCommentForm-${comment.uid}" style="display: none; margin-top: 5px;">
                    <input type="text" id="editCommentContent-${comment.uid}" value="${comment.content}" style="width: 80%;">
                    <button onclick="saveCommentEdit(${comment.uid}, ${postId})" style="font-size: 12px;">Save</button>
                    <button onclick="cancelCommentEdit(${comment.uid})" style="font-size: 12px;">Cancel</button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

// Comment edit functions
function editComment(commentId) {
    document.getElementById(`editCommentForm-${commentId}`).style.display = 'block';
}

function cancelCommentEdit(commentId) {
    document.getElementById(`editCommentForm-${commentId}`).style.display = 'none';
}

async function saveCommentEdit(commentId, postId) {
    const content = document.getElementById(`editCommentContent-${commentId}`).value;
    
    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        const result = await response.json();
        if (result.success) {
            // Refresh comments to show the (edited) label
            await loadComments(postId);
        } else {
            alert('Failed to update comment');
        }
        
    } catch (error) {
        console.error('Error updating comment:', error);
        alert('Error updating comment');
    }
}

async function deleteComment(commentId, postId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            await loadComments(postId); // Refresh comments
        } else {
            alert('Failed to delete comment');
        }
        
    } catch (error) {
        console.error('Error deleting comment:', error);
        alert('Error deleting comment');
    }
}


// Set up comment form for a specific post
function setupCommentForm(postId) {
    document.getElementById(`commentForm-${postId}`).addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = document.getElementById(`commentContent-${postId}`).value;
        
        try {
            const response = await fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });
            
            const result = await response.json();
            console.log('Comment created:', result);
            
            // Clear form and reload comments
            document.getElementById(`commentContent-${postId}`).value = '';
            await loadComments(postId);
            
        } catch (error) {
            console.error('Error creating comment:', error);
        }
    });
}


// Create post form submission
document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value
    };
    
    try {
        const response = await fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        console.log('Post created:', result);
        
        // Hide form and reload posts
        document.getElementById('createPostForm').style.display = 'none';
        document.getElementById('postForm').reset();
        loadPosts(); // Refresh the posts list
        
    } catch (error) {
        console.error('Error creating post:', error);
    }
});

// Helper function to check if user can delete comment (comment owner OR post owner)
function checkCommentPermissions(commentId, userUID, callback) {
    const query = `
        SELECT 
            c.creator_uid as comment_creator,
            p.creator_uid as post_creator
        FROM comments c 
        JOIN posts p ON c.post_uid = p.uid 
        WHERE c.uid = ?
    `;
    
    db.get(query, [commentId], (err, row) => {
        if (err) {
            return callback(err, { canEdit: false, canDelete: false });
        }
        if (!row) {
            return callback(null, { canEdit: false, canDelete: false });
        }
        
        const canEdit = row.comment_creator === userUID;
        const canDelete = row.comment_creator === userUID || row.post_creator === userUID;
        
        callback(null, { canEdit, canDelete });
    });
}


// Load posts on page load
loadPosts();
</script>

</body>
</html>